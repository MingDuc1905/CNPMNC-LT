-- =================================================================
-- PHẦN 1: TẠO CẤU TRÚC BẢNG (CREATE TABLES)
-- =================================================================

-- 1. CÁC BẢNG KHÔNG CÓ KHÓA NGOẠI (Hoặc phụ thuộc vào bảng chưa tạo)
-- -----------------------------------------------------------------

create database SkyPremier2;
use SkyPremier2;

CREATE TABLE LOAI_THANH_VIEN (
    MA_LOAI VARCHAR(10) NOT NULL PRIMARY KEY,
    TEN_LOAI VARCHAR(50) NOT NULL,
    NGUONG_DIEM INT NOT NULL CHECK (NGUONG_DIEM >= 0)
);

CREATE TABLE HANG_VE (
    MA_HANGVE VARCHAR(10) NOT NULL PRIMARY KEY,
    TEN_HANGVE VARCHAR(50) NOT NULL
);

CREATE TABLE KHUYEN_MAI (
    MAKM VARCHAR(10) NOT NULL PRIMARY KEY,
    TIEU_DE VARCHAR(100) NOT NULL,
    NOI_DUNG TEXT,
    NGAY_BAT_DAU DATE NOT NULL,
    NGAY_KET_THUC DATE NOT NULL,
    CHECK (NGAY_KET_THUC >= NGAY_BAT_DAU)
);

CREATE TABLE THANH_PHO (
    MA_THANH_PHO VARCHAR(10) NOT NULL PRIMARY KEY,
    TEN_THANH_PHO VARCHAR(100) NOT NULL UNIQUE
);


-- 2. CÁC BẢNG CÓ KHÓA NGOẠI (Phụ thuộc vào các bảng đã tạo)
-- -----------------------------------------------------------------
CREATE TABLE SAN_BAY (
    MA_SAN_BAY VARCHAR(10) NOT NULL PRIMARY KEY,
    TEN_SAN_BAY VARCHAR(100) NOT NULL,
    MA_THANH_PHO VARCHAR(10) NOT NULL,
    FOREIGN KEY (MA_THANH_PHO) REFERENCES THANH_PHO(MA_THANH_PHO)
);

CREATE TABLE KHACH_HANG (
    MAKH VARCHAR(10) NOT NULL PRIMARY KEY,
    HO_TEN VARCHAR(100) NOT NULL,
    NGAY_SINH DATE,
    GIOI_TINH CHAR(1) CHECK (GIOI_TINH IN ('M', 'F')),
    EMAIL VARCHAR(100) NOT NULL UNIQUE,
    SDT VARCHAR(15) NOT NULL,
    MAT_KHAU VARCHAR(255) NOT NULL,
    MA_LOAI VARCHAR(10) NOT NULL,
    FOREIGN KEY (MA_LOAI) REFERENCES LOAI_THANH_VIEN(MA_LOAI)
);

CREATE TABLE CHUYEN_BAY (
    MACHUYEN VARCHAR(10) NOT NULL PRIMARY KEY,
    GIO_DI DATETIME NOT NULL,
    GIO_DEN DATETIME NOT NULL,
    SO_HIEU_CHUYEN_BAY VARCHAR(20) NOT NULL UNIQUE,
    HANG_HANG_KHONG VARCHAR(50) NOT NULL,
    TRANG_THAI VARCHAR(20) NOT NULL,
    MA_SAN_BAY_DI VARCHAR(10) NOT NULL,
    MA_SAN_BAY_DEN VARCHAR(10) NOT NULL,
    FOREIGN KEY (MA_SAN_BAY_DI) REFERENCES SAN_BAY(MA_SAN_BAY),
    FOREIGN KEY (MA_SAN_BAY_DEN) REFERENCES SAN_BAY(MA_SAN_BAY)
);

CREATE TABLE GIA_VE_THEO_HANG (
    MACHUYEN VARCHAR(10) NOT NULL,
    MA_HANGVE VARCHAR(10) NOT NULL,
    GIA DECIMAL(15, 2) NOT NULL CHECK (GIA >= 0),
    PRIMARY KEY (MACHUYEN, MA_HANGVE),
    FOREIGN KEY (MACHUYEN) REFERENCES CHUYEN_BAY(MACHUYEN),
    FOREIGN KEY (MA_HANGVE) REFERENCES HANG_VE(MA_HANGVE)
);

CREATE TABLE DAT_VE (
    MADATVE VARCHAR(10) NOT NULL PRIMARY KEY,
    MAKH VARCHAR(10) NOT NULL,
    MACHUYEN VARCHAR(10) NOT NULL,
    NGAY_DAT DATETIME NOT NULL,
    TONG_TIEN DECIMAL(15, 2) NOT NULL CHECK (TONG_TIEN >= 0),
    TRANG_THAI ENUM('Chờ thanh toán', 'Đã thanh toán', 'Đã hủy') NOT NULL,
    FOREIGN KEY (MAKH) REFERENCES KHACH_HANG(MAKH),
    FOREIGN KEY (MACHUYEN) REFERENCES CHUYEN_BAY(MACHUYEN)
);

CREATE TABLE VE_CHI_TIET (
    MAVE VARCHAR(10) NOT NULL PRIMARY KEY,
    MADATVE VARCHAR(10) NOT NULL,
    HO_TEN_HANH_KHACH VARCHAR(100) NOT NULL,
    SO_GHE VARCHAR(10) NOT NULL,
    MA_HANGVE VARCHAR(10) NOT NULL,
    GIA_VE DECIMAL(15, 2) NOT NULL CHECK (GIA_VE >= 0),
    DICH_VU_BO_SUNG TEXT,
    FOREIGN KEY (MADATVE) REFERENCES DAT_VE(MADATVE),
    FOREIGN KEY (MA_HANGVE) REFERENCES HANG_VE(MA_HANGVE)
);

CREATE TABLE HOA_DON (
    MAHD VARCHAR(10) NOT NULL PRIMARY KEY,
    MADATVE VARCHAR(10) NOT NULL,
    NGAY_LAP DATE NOT NULL,
    TONG_TIEN DECIMAL(15, 2) NOT NULL CHECK (TONG_TIEN >= 0),
    TRANG_THAI ENUM('Chưa thanh toán', 'Đã thanh toán', 'Đã hủy') NOT NULL,
    FOREIGN KEY (MADATVE) REFERENCES DAT_VE(MADATVE)
);

CREATE TABLE KHUYEN_MAI_KHACH_HANG(
    MAKM VARCHAR(10) NOT NULL,
    MAKH VARCHAR(10) NOT NULL,
    NGAY_AP_DUNG DATE,
    TRANG_THAI ENUM('Đã dùng', 'Chưa dùng', 'Hết hạn'),
    PRIMARY KEY (MAKM, MAKH),
    FOREIGN KEY (MAKM) REFERENCES KHUYEN_MAI(MAKM),
    FOREIGN KEY (MAKH) REFERENCES KHACH_HANG(MAKH)
);

CREATE TABLE TICH_DIEM (
    MA_TD VARCHAR(10) NOT NULL PRIMARY KEY,
    MAKH VARCHAR(10) NOT NULL,
    NGUON_TICH_DIEM VARCHAR(50) NOT NULL,
    DIEM INT NOT NULL CHECK (DIEM >= 0),
    NGAY_GHI_NHAN TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (MAKH) REFERENCES KHACH_HANG(MAKH)
);

CREATE TABLE TONG_DIEM (
    MAKH VARCHAR(10) NOT NULL PRIMARY KEY,
    TONG_DIEM INT NOT NULL DEFAULT 0 CHECK (TONG_DIEM >= 0),
    MA_LOAI VARCHAR(10) NOT NULL,
    FOREIGN KEY (MAKH) REFERENCES KHACH_HANG(MAKH),
    FOREIGN KEY (MA_LOAI) REFERENCES LOAI_THANH_VIEN(MA_LOAI)
);

CREATE TABLE THONG_BAO (
    MATHONGBAO VARCHAR(10) NOT NULL PRIMARY KEY,
    MAKH VARCHAR(10) NOT NULL,
    NOI_DUNG TEXT NOT NULL,
    NGAY_GUI DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    LOAI_THONG_BAO VARCHAR(50) NOT NULL,
    FOREIGN KEY (MAKH) REFERENCES KHACH_HANG(MAKH)
);


-- =================================================================
-- PHẦN 2: THÊM DỮ LIỆU MẪU (INSERT DATA)
-- =================================================================

-- Thêm dữ liệu vào các bảng không phụ thuộc
INSERT INTO LOAI_THANH_VIEN (MA_LOAI, TEN_LOAI, NGUONG_DIEM) VALUES
('LTV01', 'Đồng', 0),
('LTV02', 'Bạc', 5000),
('LTV03', 'Vàng', 10000);

INSERT INTO HANG_VE (MA_HANGVE, TEN_HANGVE) VALUES
('ECO', 'Phổ thông'),
('BUS', 'Thương gia');

INSERT INTO THANH_PHO (MA_THANH_PHO, TEN_THANH_PHO) VALUES
('SGN', 'TP. Hồ Chí Minh'),
('HAN', 'Hà Nội'),
('DAD', 'Đà Nẵng');

INSERT INTO SAN_BAY (MA_SAN_BAY, TEN_SAN_BAY, MA_THANH_PHO) VALUES
('SGN', 'Sân bay Quốc tế Tân Sơn Nhất', 'SGN'),
('HAN', 'Sân bay Quốc tế Nội Bài', 'HAN'),
('DAD', 'Sân bay Quốc tế Đà Nẵng', 'DAD');

-- Thêm dữ liệu vào các bảng phụ thuộc
INSERT INTO KHACH_HANG (MAKH, HO_TEN, NGAY_SINH, GIOI_TINH, EMAIL, SDT, MAT_KHAU, MA_LOAI) VALUES
('KH001', 'Nguyễn Văn An', '1990-01-15', 'M', 'an.nguyen@email.com', '0901234567', 'hashed_password_1', 'LTV01'),
('KH002', 'Trần Thị Bích', '1995-05-20', 'F', 'bich.tran@email.com', '0987654321', 'hashed_password_2', 'LTV01');

INSERT INTO CHUYEN_BAY (MACHUYEN, GIO_DI, GIO_DEN, SO_HIEU_CHUYEN_BAY, HANG_HANG_KHONG, TRANG_THAI, MA_SAN_BAY_DI, MA_SAN_BAY_DEN) VALUES 
('CB001', '2025-09-10 08:00:00', '2025-09-10 10:05:00', 'VN244', 'Vietnam Airlines', 'Đúng giờ', 'SGN', 'HAN'),
('CB002', '2025-09-11 14:30:00', '2025-09-11 15:50:00', 'VJ161', 'VietJet Air', 'Đúng giờ', 'HAN', 'DAD');

INSERT INTO GIA_VE_THEO_HANG (MACHUYEN, MA_HANGVE, GIA) VALUES
('CB001', 'ECO', 1500000.00),
('CB001', 'BUS', 3500000.00),
('CB002', 'ECO', 1200000.00);

INSERT INTO DAT_VE (MADATVE, MAKH, MACHUYEN, NGAY_DAT, TONG_TIEN, TRANG_THAI) VALUES
('DV001', 'KH001', 'CB001', '2025-07-12 10:30:00', 3500000.00, 'Đã thanh toán');

INSERT INTO VE_CHI_TIET (MAVE, MADATVE, HO_TEN_HANH_KHACH, SO_GHE, MA_HANGVE, GIA_VE) VALUES
('VE001', 'DV001', 'Nguyễn Văn An', '5A', 'BUS', 3500000.00);

INSERT INTO HOA_DON (MAHD, MADATVE, NGAY_LAP, TONG_TIEN, TRANG_THAI) VALUES
('HD001', 'DV001', '2025-07-12', 3500000.00, 'Đã thanh toán');

INSERT IGNORE INTO THANH_PHO (MA_THANH_PHO, TEN_THANH_PHO) VALUES
('PQC', 'Phú Quốc');
INSERT IGNORE INTO SAN_BAY (MA_SAN_BAY, TEN_SAN_BAY, MA_THANH_PHO) VALUES
('PQC', 'Sân bay Quốc tế Phú Quốc', 'PQC');

INSERT IGNORE INTO THANH_PHO (MA_THANH_PHO, TEN_THANH_PHO) VALUES
('NTC', 'Nha Trang');
INSERT IGNORE INTO SAN_BAY (MA_SAN_BAY, TEN_SAN_BAY, MA_THANH_PHO) VALUES
('NTC', 'Sân bay Cam Ranh', 'NTC');

INSERT INTO CHUYEN_BAY (MACHUYEN, GIO_DI, GIO_DEN, SO_HIEU_CHUYEN_BAY, HANG_HANG_KHONG, TRANG_THAI, MA_SAN_BAY_DI, MA_SAN_BAY_DEN)
VALUES 
('CB005', '2025-09-12 17:00:00', '2025-09-12 20:20:00', 'AH167', 'Bamboo Airways', 'Đúng giờ', 'NTC', 'SGN'),
('CB006', '2025-09-15 13:30:00', '2025-09-15 16:40:00', 'VN1237', 'Vietnam Airlines', 'Đúng giờ', 'HAN', 'NTC');

INSERT INTO GIA_VE_THEO_HANG (MACHUYEN, MA_HANGVE, GIA) VALUES
('CB005', 'ECO', 1350000.00), 
('CB006', 'BUS', 3550000.00);

INSERT INTO CHUYEN_BAY (MACHUYEN, GIO_DI, GIO_DEN, SO_HIEU_CHUYEN_BAY, HANG_HANG_KHONG, TRANG_THAI, MA_SAN_BAY_DI, MA_SAN_BAY_DEN)
VALUES 
('CB003', '2025-09-12 18:00:00', '2025-09-12 19:20:00', 'QH154', 'Bamboo Airways', 'Đúng giờ', 'SGN', 'DAD'),
('CB004', '2025-09-15 11:30:00', '2025-09-15 13:40:00', 'VN1235', 'Vietnam Airlines', 'Đúng giờ', 'HAN', 'PQC');

INSERT INTO GIA_VE_THEO_HANG (MACHUYEN, MA_HANGVE, GIA) VALUES
('CB003', 'ECO', 1350000.00), -- Giá vé cho chuyến Sài Gòn -> Đà Nẵng
('CB004', 'ECO', 1850000.00), -- Giá vé Phổ thông cho chuyến Hà Nội -> Phú Quốc
('CB004', 'BUS', 4100000.00); -- Giá vé Thương gia cho chuyến Hà Nội -> Phú Quốc

select * from chuyen_bay